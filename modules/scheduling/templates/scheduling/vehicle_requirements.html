{% extends 'base.html' %}

{% block title %}
车辆需求 - 安徽XX智能运力系统
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --feishu-primary: #3370ff;
        --feishu-success: #00d6b9;
        --feishu-warning: #ff8f1f;
        --feishu-error: #f54a45;
        --feishu-text-primary: #1f2329;
        --feishu-text-secondary: #646a73;
        --feishu-text-tertiary: #8f959e;
        --feishu-border: #e4e6eb;
        --feishu-bg: #f7f8fa;
        --feishu-white: #ffffff;
        --feishu-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --feishu-shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
        --feishu-shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
        --feishu-radius: 8px;
        --feishu-radius-lg: 12px;
    }

    .dispatch-container {
        padding: 24px;
        background: var(--feishu-bg);
        min-height: calc(100vh - 120px);
    }

    .dispatch-header {
        margin-bottom: 24px;
        padding: 0;
        border-bottom: none;
    }

    .dispatch-header h2 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 24px;
    }

    .dispatch-header p {
        color: var(--feishu-text-secondary);
        font-size: 14px;
        margin: 0;
    }

    /* 飞书风格卡片 */
    .feishu-card {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-md);
        border: 1px solid var(--feishu-border);
        transition: all 0.2s ease;
    }

    .feishu-card:hover {
        box-shadow: var(--feishu-shadow-lg);
    }

    .dispatch-form {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-md);
        border: 1px solid var(--feishu-border);
        padding: 32px;
        margin-bottom: 24px;
    }

    .dispatch-form h4 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 24px;
        font-size: 18px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--feishu-text-primary);
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--feishu-border);
        border-radius: var(--feishu-radius);
        font-size: 14px;
        transition: all 0.2s ease;
        background: var(--feishu-white);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--feishu-primary);
        box-shadow: 0 0 0 2px rgba(51, 112, 255, 0.1);
    }

    .form-control::placeholder {
        color: var(--feishu-text-tertiary);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--feishu-primary), #5b8bff);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: var(--feishu-radius);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(51, 112, 255, 0.2);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2968ff, #4a78ff);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(51, 112, 255, 0.3);
    }

    .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(51, 112, 255, 0.2);
    }

    .dispatch-list {
        margin-top: 24px;
    }

    .dispatch-list h4 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 16px;
        font-size: 18px;
    }

    .dispatch-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .dispatch-item {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-sm);
        border: 1px solid var(--feishu-border);
        padding: 16px;
        transition: all 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .dispatch-item:hover {
        box-shadow: var(--feishu-shadow-md);
        transform: translateY(-2px);
    }

    .dispatch-item-content {
        flex: 1;
    }

    @media (max-width: 768px) {
        .dispatch-grid {
            grid-template-columns: 1fr;
        }
    }

    .dispatch-item h6 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 16px;
    }

    .dispatch-item p {
        color: var(--feishu-text-secondary);
        margin-bottom: 8px;
        font-size: 14px;
    }

    .dispatch-item small {
        color: var(--feishu-text-tertiary);
        font-size: 13px;
    }

    .dispatch-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid transparent;
    }

    .status-pending {
        background-color: rgba(255, 143, 31, 0.1);
        color: #ff8f1f;
        border-color: rgba(255, 143, 31, 0.3);
    }

    .status-assigned {
        background-color: rgba(51, 112, 255, 0.1);
        color: var(--feishu-primary);
        border-color: rgba(51, 112, 255, 0.3);
    }

    .status-completed {
        background-color: rgba(0, 214, 185, 0.1);
        color: var(--feishu-success);
        border-color: rgba(0, 214, 185, 0.3);
    }

    .status-rejected {
        background-color: rgba(245, 74, 69, 0.1);
        color: var(--feishu-error);
        border-color: rgba(245, 74, 69, 0.3);
    }

    /* 飞书按钮样式 */
    .feishu-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: var(--feishu-radius);
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
    }

    .feishu-btn-primary {
        background: var(--feishu-primary);
        color: white;
        border-color: var(--feishu-primary);
    }

    .feishu-btn-primary:hover {
        background: #2968ff;
        border-color: #2968ff;
        color: white;
    }

    .feishu-btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }

    /* 飞书状态标签 */
    .feishu-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        line-height: 1.5;
    }

    .feishu-badge-pending {
        background-color: rgba(255, 143, 31, 0.1);
        color: #ff8f1f;
    }

    .feishu-badge-processing {
        background-color: rgba(51, 112, 255, 0.1);
        color: var(--feishu-primary);
    }

    .feishu-badge-completed {
        background-color: rgba(0, 214, 185, 0.1);
        color: var(--feishu-success);
    }

    .feishu-badge-error {
        background-color: rgba(245, 74, 69, 0.1);
        color: var(--feishu-error);
    }

    /* 响应式布局 */
    @media (max-width: 768px) {
        .dispatch-container {
            padding: 16px;
        }

        .dispatch-form {
            padding: 20px;
        }

        .dispatch-header h2 {
            font-size: 20px;
        }
    }

    /* 加载状态 */
    .text-center {
        text-align: center;
    }
    
    .py-4 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }
    
    .spinner-border {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        vertical-align: text-bottom;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
    }
    
    .text-primary {
        color: var(--feishu-primary);
    }
    
    .fa-3x {
        font-size: 3em;
    }
    
    .mb-3 {
        margin-bottom: 1rem;
    }
    
    .mt-2 {
        margin-top: 0.5rem;
    }
    
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="dispatch-container">
    <div class="dispatch-header">
        <h2><i class="fas fa-truck-loading"></i> 车辆需求申请</h2>
        <p>车间地调专用：提交车辆运输需求，等待调度中心分配车辆</p>
    </div>


<div class="row">
    <div class="col-md-4">
        <div class="info-card">
            <h5><i class="fas fa-phone"></i> 紧急联系</h5>
            <p>调度中心电话：<strong>400-123-4567</strong><br>
            紧急联系人：<strong>张调度 138-0000-1234</strong></p>
        </div>
    </div>
    <div class="col-md-8">
        <div class="dispatch-form">
            <h4>提交车辆需求</h4>
            <form id="requirementsForm">
                <div class="form-group">
                    <label class="form-label">需求类型</label>
                    <select class="feishu-form-control" name="requirement_type" required>
                        <option value="加班" selected>加班</option>
                        <option value="正班">正班</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">始发局</label>
                    <input type="text" class="feishu-form-control" name="start_location" placeholder="请输入始发局" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">邮路名称</label>
                    <input type="text" class="feishu-form-control" name="end_location" placeholder="请输入邮路名称" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">委办承运公司</label>
                    <input type="text" class="feishu-form-control" name="carrier_company" id="carrierCompanyInput" placeholder="请选择或输入委办承运公司" list="carrierCompanyList" required>
                    <datalist id="carrierCompanyList"></datalist>
                </div>
                
                <div class="form-group">
                    <label class="form-label">运输类型</label>
                    <select class="feishu-form-control" name="transport_type" required>
                        <option value="">请选择运输类型</option>
                        <option value="单程">单程</option>
                        <option value="往返">往返</option>
                    </select>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">重量 (吨)</label>
                            <select class="feishu-form-control" name="weight" id="weightSelect" required>
                                <option value="">请选择重量</option>
                                <option value="5" data-min-volume="35">5吨</option>
                                <option value="8" data-min-volume="45">8吨</option>
                                <option value="12" data-min-volume="55">12吨</option>
                                <option value="20" data-min-volume="100">20吨</option>
                                <option value="30" data-min-volume="130">30吨</option>
                                <option value="40A" data-min-volume="150">40吨A</option>
                                <option value="40B" data-min-volume="180">40吨B</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">容积 (立方米)</label>
                            <input type="number" class="feishu-form-control" name="volume" id="volumeInput" placeholder="请选择重量后输入容积" min="0" step="1" required>
                            <small class="form-text text-muted" id="volumeHint">请先选择重量，容积必须大于等于对应最小值</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">要求用车时间</label>
                    <input type="datetime-local" class="feishu-form-control" name="required_time" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">特殊要求（可选）</label>
                    <textarea class="feishu-form-control" name="special_requirements" rows="3" placeholder="如有特殊要求请在此说明（如车型、装卸要求等，选填）"></textarea>
                </div>
                
                <button type="submit" class="feishu-btn feishu-btn-primary">
                    <i class="fas fa-paper-plane"></i> 提交需求申请
                </button>
            </form>
        </div>
    </div>
    
    
</div>

<div class="dispatch-list">
    <h4>我的需求记录</h4>
    <div id="loading-requirements" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="text-muted mt-2">正在加载需求记录...</p>
    </div>
    <div id="no-requirements" class="text-center py-4" style="display: none;">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">暂无需求记录</p>
    </div>
    <div id="requirements-container" class="dispatch-grid"></div>
</div>

<script>
// 重量和容积映射关系
        const weightVolumeMap = {
            '5': { min: 35, next: 45 },
            '8': { min: 45, next: 55 },
            '12': { min: 55, next: 100 },
            '20': { min: 100, next: 130 },
            '30': { min: 130, next: 150 },
            '40A': { min: 150, next: 180 },
            '40B': { min: 180, next: null }
        };

// 重量选择变化处理
document.getElementById('weightSelect').addEventListener('change', function() {
    const weight = this.value;
    const volumeInput = document.getElementById('volumeInput');
    const volumeHint = document.getElementById('volumeHint');
    
    if (weight && weightVolumeMap[weight]) {
        const minVolume = weightVolumeMap[weight].min;
        volumeInput.min = minVolume;
        volumeInput.placeholder = `最小容积 ${minVolume} 立方米`;
        volumeHint.textContent = `容积必须大于等于 ${minVolume} 立方米`;
        volumeInput.disabled = false;
        volumeInput.value = minVolume; // 默认填充最小值
    } else {
        volumeInput.min = 0;
        volumeInput.placeholder = '请选择重量后输入容积';
        volumeHint.textContent = '请先选择重量，容积必须大于等于对应最小值';
        volumeInput.disabled = true;
        volumeInput.value = '';
    }
});

// 容积输入验证
document.getElementById('volumeInput').addEventListener('input', function() {
    const weight = document.getElementById('weightSelect').value;
    const volume = parseInt(this.value);
    
    if (weight && weightVolumeMap[weight]) {
        const minVolume = weightVolumeMap[weight].min;
        const maxVolume = weightVolumeMap[weight].next;
        
        if (volume < minVolume) {
            this.setCustomValidity(`容积必须大于等于 ${minVolume} 立方米`);
        } else if (maxVolume && volume >= maxVolume) {
            this.setCustomValidity(`容积必须小于 ${maxVolume} 立方米`);
        } else {
            this.setCustomValidity('');
        }
    }
});

// 表单提交处理
document.getElementById('requirementsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // 容积验证
    const weight = data.weight;
    const volume = parseInt(data.volume);
    
    if (weight && weightVolumeMap[weight]) {
        const minVolume = weightVolumeMap[weight].min;
        const maxVolume = weightVolumeMap[weight].next;
        
        if (volume < minVolume) {
            alert(`容积必须大于等于 ${minVolume} 立方米`);
            return;
        }
        if (maxVolume && volume >= maxVolume) {
            alert(`容积必须小于 ${maxVolume} 立方米`);
            return;
        }
    }
    
    // 必填字段验证
    const requiredFields = ['requirement_type', 'start_location', 'end_location', 
                          'transport_type', 'weight', 'volume', 'required_time'];
    
    for (const field of requiredFields) {
        if (!data[field]) {
            alert(`请填写 ${field} 字段！`);
            return;
        }
    }
    
    // 导入并使用companySelector.js模块进行公司选择验证
    import('/static/modules/companySelector.js').then(module => {
        if (!module.validateCompanySelection()) {
            return;
        }
    }).catch(error => {
        console.error('加载companySelector模块失败:', error);
        alert('系统错误，请刷新页面重试');
        return;
    });
    
    // 获取当前用户角色
    const userRole = "{{ session.get('user_role', '') }}";
    
    // 准备API数据 - 使用后端验证期望的字段名
    const apiData = {
        requirement_type: data.requirement_type,
        start_location: data.start_location,
        end_location: data.end_location,
        carrier_company: data.carrier_company, // 使用用户输入或选择的公司名称
        transport_type: data.transport_type,
        weight: data.weight,
        volume: parseInt(data.volume),
        required_time: data.required_time,
        special_requirements: data.special_requirements || '',
        dispatch_track: '轨道A' // 车间地调固定使用轨道A
    };
    
    // 显示加载状态
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
    submitBtn.disabled = true;
    
    // 使用fetch API创建任务
        fetch('/api/dispatch/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(apiData)
        })
        .then(response => {
            if (!response.ok) {
            if (response.status === 401) {
                throw new Error('请先登录系统');
            }
            return response.json().then(err => {
                throw new Error(err.error?.message || '提交失败');
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            alert('需求提交成功！任务ID：' + result.data.task_id);
            this.reset();
            // 重置容积输入状态
            document.getElementById('volumeInput').disabled = true;
            document.getElementById('volumeHint').textContent = '请先选择重量，容积必须大于等于对应最小值';
            
            // 刷新需求记录列表
            loadRequirements();
        } else {
            alert('提交失败：' + (result.error?.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message === '请先登录系统') {
            alert('请先登录系统');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            alert('提交失败：' + error.message);
        }
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// 页面加载时禁用容积输入并加载需求记录
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('volumeInput').disabled = true;
    loadRequirements();
    
    // 初始化公司选择器
    import('/static/modules/companySelector.js').then(module => {
        module.initializeCompanySelector('carrierCompanyInput');
    }).catch(error => {
        console.error('初始化公司选择器失败:', error);
    });
});

// 加载需求记录列表
function loadRequirements() {
    const loadingDiv = document.getElementById('loading-requirements');
    const noRequirementsDiv = document.getElementById('no-requirements');
    const container = document.getElementById('requirements-container');
    
    loadingDiv.style.display = 'block';
    noRequirementsDiv.style.display = 'none';
    container.innerHTML = '';
    
    fetch('/api/dispatch/tasks')
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            loadingDiv.style.display = 'none';
            
            if (result.success && result.data && result.data.list && result.data.list.length > 0) {
                const requirements = result.data.list;
                
                requirements.forEach(req => {
                    const item = createRequirementItem(req);
                    container.appendChild(item);
                });
                
                noRequirementsDiv.style.display = 'none';
            } else {
                noRequirementsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('加载需求记录失败:', error);
            loadingDiv.style.display = 'none';
            noRequirementsDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="text-danger">加载失败：${error.message}</p>`;
            noRequirementsDiv.style.display = 'block';
        });
}

// 创建需求记录项 - 统一使用飞书风格样式
function createRequirementItem(req) {
    const div = document.createElement('div');
    div.className = 'dispatch-item';
    
    // 状态样式映射 - 使用飞书风格状态标签
    const statusMap = {
        '待提交': { class: 'status-pending', text: '待提交' },
        '待调度员审核': { class: 'status-pending', text: '待审核' },
        '待供应商响应': { class: 'status-pending', text: '待响应' },
        '供应商已响应': { class: 'status-assigned', text: '已响应' },
        '车间已核查': { class: 'status-assigned', text: '已核查' },
        '供应商已确认': { class: 'status-assigned', text: '已确认' },
        '任务结束': { class: 'status-completed', text: '已结束' },
        '已取消': { class: 'status-rejected', text: '已取消' },
        'pending': { class: 'status-pending', text: '待处理' },
        'processing': { class: 'status-assigned', text: '处理中' },
        'completed': { class: 'status-completed', text: '已完成' },
        'rejected': { class: 'status-rejected', text: '已拒绝' }
    };
    
    const statusInfo = statusMap[req.status] || { class: 'status-pending', text: req.status };
    
    // 格式化时间显示
    function formatDateTime(dateStr) {
        if (!dateStr) return '待定';
        try {
            return new Date(dateStr).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return dateStr;
        }
    }
    
    // 获取显示数据
    const weight = req.weight || req.cargo_weight || 0;
    const volume = req.volume || req.cargo_volume || 0;
    const transportType = req.transport_type || req.transport_type_name || '普通运输';
    const requiredTime = req.required_time || req.required_date ||  '';
    const specialReq = req.special_requirements || '';
    const createdAt = formatDateTime(req.created_at);
    const requiredTimeFormatted = formatDateTime(requiredTime);
    const startLocation = req.start_bureau || req.start_location || req.origin_bureau || '';
    const endLocation = req.route_name || req.end_location || req.destination_bureau || '';
    
    div.innerHTML = `
        <div class="dispatch-item-content">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-route text-primary me-2"></i>
                    <h6 class="mb-0">${startLocation} → ${endLocation}</h6>
                </div>
                <span class="dispatch-status ${statusInfo.class}">${statusInfo.text}</span>
            </div>
            
            <div class="mb-3">
                <div class="row">
                    <div class="col-6">
                        <p class="mb-1"><small class="text-muted">需求类型</small></p>
                        <p class="mb-1">${req.requirement_type || '车辆需求'}</p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><small class="text-muted">运输类型</small></p>
                        <p class="mb-1">${transportType}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <p class="mb-1"><small class="text-muted">重量</small></p>
                        <p class="mb-1">${weight} 吨</p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><small class="text-muted">容积</small></p>
                        <p class="mb-1">${volume} m³</p>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <p class="mb-1"><small class="text-muted">要求时间</small></p>
                <p class="mb-1">${requiredTimeFormatted}</p>
            </div>
            
            ${specialReq ? 
                `<div class="mb-3">
                    <p class="mb-1"><small class="text-muted">特殊要求</small></p>
                    <p class="mb-1">${specialReq}</p>
                </div>` : ''}
            
            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                <small class="text-muted">提交时间：${createdAt}</small>
                <button class="feishu-btn feishu-btn-primary feishu-btn-sm" onclick="viewRequirementDetails('${req.task_id}')">
                    <i class="fas fa-eye me-1"></i>查看详情
                </button>
            </div>
        </div>
    `;
    
    return div;
}

// 查看需求详情
function viewRequirementDetails(taskId) {
    if (!taskId || taskId === 'N/A') {
        alert('该需求暂无任务编号，无法查看详情');
        return;
    }
    
    // 跳转到详情页面或使用模态框显示详情
    window.open(`/modules/scheduling/task_details/${taskId}`, '_blank');
}
</script>
{% endblock %}