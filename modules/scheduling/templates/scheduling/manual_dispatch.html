{% extends 'base.html' %}

{% block title %}
äººå·¥æ´¾è½¦ - å®‰å¾½XXæ™ºèƒ½è¿åŠ›ç³»ç»Ÿ
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --feishu-primary: #3370ff;
        --feishu-success: #00d6b9;
        --feishu-warning: #ff8f1f;
        --feishu-error: #f54a45;
        --feishu-text-primary: #1f2329;
        --feishu-text-secondary: #646a73;
        --feishu-text-tertiary: #8f959e;
        --feishu-border: #e4e6eb;
        --feishu-bg: #f7f8fa;
        --feishu-white: #ffffff;
        --feishu-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --feishu-shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
        --feishu-shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
        --feishu-radius: 8px;
        --feishu-radius-lg: 12px;
    }

    .dispatch-container {
        padding: 24px;
        background: var(--feishu-bg);
        min-height: calc(100vh - 120px);
    }

    .dispatch-header {
        margin-bottom: 24px;
        padding: 0;
        border-bottom: none;
    }

    .dispatch-header h2 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 24px;
    }

    .dispatch-header p {
        color: var(--feishu-text-secondary);
        font-size: 14px;
        margin: 0;
    }

    /* é£ä¹¦é£æ ¼å¡ç‰‡ */
    .feishu-card {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-md);
        border: 1px solid var(--feishu-border);
        transition: all 0.2s ease;
    }

    .feishu-card:hover {
        box-shadow: var(--feishu-shadow-lg);
    }

    .dispatch-form {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-md);
        border: 1px solid var(--feishu-border);
        padding: 32px;
        margin-bottom: 24px;
    }

    .dispatch-form h4 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 24px;
        font-size: 18px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--feishu-text-primary);
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--feishu-border);
        border-radius: var(--feishu-radius);
        font-size: 14px;
        transition: all 0.2s ease;
        background: var(--feishu-white);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--feishu-primary);
        box-shadow: 0 0 0 2px rgba(51, 112, 255, 0.1);
    }

    .form-control::placeholder {
        color: var(--feishu-text-tertiary);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--feishu-primary), #5b8bff);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: var(--feishu-radius);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(51, 112, 255, 0.2);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2968ff, #4a78ff);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(51, 112, 255, 0.3);
    }

    .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(51, 112, 255, 0.2);
    }

    .dispatch-list {
        margin-top: 24px;
    }

    .dispatch-list h4 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 16px;
        font-size: 18px;
    }

    .dispatch-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .dispatch-item {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-sm);
        border: 1px solid var(--feishu-border);
        padding: 16px;
        transition: all 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .dispatch-item:hover {
        box-shadow: var(--feishu-shadow-md);
        transform: translateY(-2px);
    }

    .dispatch-item-content {
        flex: 1;
    }

    @media (max-width: 768px) {
        .dispatch-grid {
            grid-template-columns: 1fr;
        }
    }

    .dispatch-item h6 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 16px;
    }

    .dispatch-item p {
        color: var(--feishu-text-secondary);
        margin-bottom: 8px;
        font-size: 14px;
    }

    .dispatch-item small {
        color: var(--feishu-text-tertiary);
        font-size: 13px;
    }

    .dispatch-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid transparent;
    }

    .status-pending {
        background-color: rgba(255, 143, 31, 0.1);
        color: #ff8f1f;
        border-color: rgba(255, 143, 31, 0.3);
    }

    .status-assigned {
        background-color: rgba(51, 112, 255, 0.1);
        color: var(--feishu-primary);
        border-color: rgba(51, 112, 255, 0.3);
    }

    .status-completed {
        background-color: rgba(0, 214, 185, 0.1);
        color: var(--feishu-success);
        border-color: rgba(0, 214, 185, 0.3);
    }

    /* å¡ç‰‡æ ·å¼ä¼˜åŒ– */
    .card {
        background: var(--feishu-white);
        border-radius: var(--feishu-radius-lg);
        box-shadow: var(--feishu-shadow-md);
        border: 1px solid var(--feishu-border);
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: var(--feishu-shadow-lg);
    }

    .card-header {
        background: var(--feishu-white);
        border-bottom: 1px solid var(--feishu-border);
        padding: 16px 20px;
        border-radius: var(--feishu-radius-lg) var(--feishu-radius-lg) 0 0;
    }

    .card-header h5 {
        color: var(--feishu-text-primary);
        font-weight: 600;
        margin: 0;
        font-size: 16px;
    }

    .card-body {
        padding: 20px;
    }

    .list-group-item {
        border: 1px solid var(--feishu-border);
        border-radius: var(--feishu-radius);
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

    .list-group-item:hover {
        box-shadow: var(--feishu-shadow-sm);
    }

    .badge {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
    }

    .bg-success {
        background-color: var(--feishu-success) !important;
    }

    .bg-warning {
        background-color: var(--feishu-warning) !important;
    }

    /* å“åº”å¼å¸ƒå±€ */
    @media (max-width: 768px) {
        .dispatch-container {
            padding: 16px;
        }

        .dispatch-form {
            padding: 20px;
        }

        .dispatch-header h2 {
            font-size: 20px;
        }
    }

    /* ä»»åŠ¡å¡ç‰‡ç½‘æ ¼å¸ƒå±€ä¼˜åŒ– */
    .task-grid-container {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -15px;
    }

    .task-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 380px;
        display: flex;
        flex-direction: column;
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .feishu-col-lg-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
        padding: 0 15px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .feishu-col-lg-4 {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dispatch-container">
    <div class="dispatch-header">
        <h2><i class="fas fa-user-cog"></i> äººå·¥æ´¾è½¦</h2>
        <p>äººå·¥è°ƒåº¦è½¦è¾†ï¼Œçµæ´»å¤„ç†ç‰¹æ®Šè¿è¾“éœ€æ±‚å’Œç´§æ€¥æƒ…å†µ</p>
    </div>

    <div class="row">
        <div class="col-md-12">
                <div class="dispatch-form feishu-card">
                    <h4>åˆ›å»ºæ´¾è½¦ä»»åŠ¡</h4>
            <form id="dispatchForm">
                <div class="form-group">
                    <label class="form-label">éœ€æ±‚ç±»å‹ *</label>
                    <select class="form-control" name="requirement_type" required>
                        <option value="">è¯·é€‰æ‹©éœ€æ±‚ç±»å‹</option>
                        <option value="åŠ ç­">åŠ ç­</option>
                        <option value="æ­£ç­">æ­£ç­</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å§‹å‘å±€ *</label>
                    <input type="text" class="form-control" name="start_location" placeholder="è¯·è¾“å…¥å§‹å‘å±€" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é‚®è·¯åç§° *</label>
                    <input type="text" class="form-control" name="end_location" placeholder="è¯·è¾“å…¥é‚®è·¯åç§°" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å§”åŠæ‰¿è¿å…¬å¸ *</label>
                    <select class="form-control" name="carrier_company" required>
                        <option value="">è¯·é€‰æ‹©å§”åŠæ‰¿è¿å…¬å¸</option>
                        <option value="ä¸­å›½é‚®æ”¿é€Ÿé€’ç‰©æµ">ä¸­å›½é‚®æ”¿é€Ÿé€’ç‰©æµ</option>
                        <option value="é¡ºä¸°é€Ÿè¿">é¡ºä¸°é€Ÿè¿</option>
                        <option value="åœ†é€šé€Ÿé€’">åœ†é€šé€Ÿé€’</option>
                        <option value="ä¸­é€šå¿«é€’">ä¸­é€šå¿«é€’</option>
                        <option value="ç”³é€šå¿«é€’">ç”³é€šå¿«é€’</option>
                        <option value="éŸµè¾¾å¿«é€’">éŸµè¾¾å¿«é€’</option>
                        <option value="ç™¾ä¸–å¿«é€’">ç™¾ä¸–å¿«é€’</option>
                        <option value="å¾·é‚¦ç‰©æµ">å¾·é‚¦ç‰©æµ</option>
                        <option value="äº¬ä¸œç‰©æµ">äº¬ä¸œç‰©æµ</option>
                        <option value="èœé¸Ÿç½‘ç»œ">èœé¸Ÿç½‘ç»œ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¿è¾“ç±»å‹ *</label>
                    <select class="form-control" name="transport_type" required>
                        <option value="">è¯·é€‰æ‹©è¿è¾“ç±»å‹</option>
                        <option value="å•ç¨‹">å•ç¨‹</option>
                        <option value="å¾€è¿”">å¾€è¿”</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é‡é‡å¨ *</label>
                    <select class="form-control" name="weight" id="weightSelect" required>
                        <option value="">è¯·é€‰æ‹©é‡é‡å¨</option>
                        <option value="5">5å¨</option>
                        <option value="8">8å¨</option>
                        <option value="12">12å¨</option>
                        <option value="20">20å¨</option>
                        <option value="30">30å¨</option>
                        <option value="40A">40å¨A</option>
                                <option value="40B">40å¨B</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å®¹ç§¯ (ç«‹æ–¹ç±³) *</label>
                    <input type="number" class="form-control" name="volume" id="volumeInput" placeholder="è¯·é€‰æ‹©é‡é‡åè¾“å…¥å®¹ç§¯" min="1" required>
                    <small id="volumeHint" class="form-text text-muted">è¯·å…ˆé€‰æ‹©é‡é‡ï¼Œå®¹ç§¯å¿…é¡»å¤§äºç­‰äºå¯¹åº”æœ€å°å€¼</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¦æ±‚ç”¨è½¦æ—¶é—´ *</label>
                    <input type="datetime-local" class="form-control" name="required_time" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç‰¹æ®Šè¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-control" name="special_requirements" rows="3" placeholder="è¯·è¾“å…¥ç‰¹æ®Šè¦æ±‚ï¼ˆé€‰å¡«ï¼‰"></textarea>
                </div>
                
                <button type="submit" class="btn-primary">
                    <i class="fas fa-paper-plane"></i> åˆ›å»ºæ´¾è½¦ä»»åŠ¡
                </button>
            </form>
        </div>
    </div>
</div>

    <div class="dispatch-list">
        <h4><i class="fas fa-history"></i> æˆ‘çš„æ´¾è½¦è®°å½•</h4>
        <div id="loading-tasks" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="text-muted mt-2">æ­£åœ¨åŠ è½½æ´¾è½¦è®°å½•...</p>
        </div>
        <div id="no-tasks" class="text-center py-4" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">æš‚æ— æ´¾è½¦è®°å½•</p>
        </div>
        <div id="tasks-container" class="dispatch-grid"></div>
    </div>
</div>

<script>
// é‡é‡å’Œå®¹ç§¯æ˜ å°„å…³ç³»
        const weightVolumeMap = {
            '5': { min: 35, next: 45 },
            '8': { min: 45, next: 55 },
            '12': { min: 55, next: 100 },
            '20': { min: 100, next: 130 },
            '30': { min: 130, next: 150 },
            '40A': { min: 150, next: 180 },
            '40B': { min: 180, next: null }
        };

// é‡é‡é€‰æ‹©å˜åŒ–å¤„ç†
document.getElementById('weightSelect').addEventListener('change', function() {
    const weight = this.value;
    const volumeInput = document.getElementById('volumeInput');
    const volumeHint = document.getElementById('volumeHint');
    
    if (weight && weightVolumeMap[weight]) {
        const minVolume = weightVolumeMap[weight].min;
        volumeInput.min = minVolume;
        volumeInput.placeholder = `æœ€å°å®¹ç§¯ ${minVolume} ç«‹æ–¹ç±³`;
        volumeHint.textContent = `å®¹ç§¯å¿…é¡»å¤§äºç­‰äº ${minVolume} ç«‹æ–¹ç±³`;
        volumeInput.disabled = false;
        volumeInput.value = minVolume; // é»˜è®¤å¡«å……æœ€å°å€¼
    } else {
        volumeInput.min = 0;
        volumeInput.placeholder = 'è¯·é€‰æ‹©é‡é‡åè¾“å…¥å®¹ç§¯';
        volumeHint.textContent = 'è¯·å…ˆé€‰æ‹©é‡é‡ï¼Œå®¹ç§¯å¿…é¡»å¤§äºç­‰äºå¯¹åº”æœ€å°å€¼';
        volumeInput.disabled = true;
        volumeInput.value = '';
    }
});

// å®¹ç§¯è¾“å…¥éªŒè¯
document.getElementById('volumeInput').addEventListener('input', function() {
    const weight = document.getElementById('weightSelect').value;
    const volume = parseInt(this.value);
    
    if (weight && weightVolumeMap[weight]) {
        const minVolume = weightVolumeMap[weight].min;
        const maxVolume = weightVolumeMap[weight].next;
        
        if (volume < minVolume) {
            this.setCustomValidity(`å®¹ç§¯å¿…é¡»å¤§äºç­‰äº ${minVolume} ç«‹æ–¹ç±³`);
        } else if (maxVolume && volume >= maxVolume) {
            this.setCustomValidity(`å®¹ç§¯å¿…é¡»å°äº ${maxVolume} ç«‹æ–¹ç±³`);
        } else {
            this.setCustomValidity('');
        }
    }
});

// è¡¨å•æäº¤å¤„ç†
document.getElementById('dispatchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // å®¹ç§¯éªŒè¯
    const weight = data.weight;
    const volume = parseInt(data.volume);
    
    if (weight && weightVolumeMap[weight]) {
        const minVolume = weightVolumeMap[weight].min;
        const maxVolume = weightVolumeMap[weight].next;
        
        if (volume < minVolume) {
            alert(`å®¹ç§¯å¿…é¡»å¤§äºç­‰äº ${minVolume} ç«‹æ–¹ç±³`);
            return;
        }
        if (maxVolume && volume >= maxVolume) {
            alert(`å®¹ç§¯å¿…é¡»å°äº ${maxVolume} ç«‹æ–¹ç±³`);
            return;
        }
    }
    
    // å¿…å¡«å­—æ®µéªŒè¯
    const requiredFields = ['requirement_type', 'start_location', 'end_location', 
                          'carrier_company', 'transport_type', 'weight', 'volume', 'required_time'];
    
    for (const field of requiredFields) {
        if (!data[field]) {
            alert(`è¯·å¡«å†™ ${field} å­—æ®µï¼`);
            return;
        }
    }
    
    // è·å–å½“å‰ç”¨æˆ·è§’è‰²
    const userRole = "{{ session.get('user_role', '') }}";
    console.log('å½“å‰ç”¨æˆ·è§’è‰²:', userRole, 'ç±»å‹:', typeof userRole);
    
    // æ ¹æ®è§’è‰²ç¡®å®šè½¨é“ç±»å‹
    let dispatchTrack = 'è½¨é“A'; // é»˜è®¤
    if (userRole === 'è½¦é—´åœ°è°ƒ') {
        dispatchTrack = 'è½¨é“A';
        console.log('è®¾ç½®ä¸ºè½¨é“A - è½¦é—´åœ°è°ƒ');
    } else if (userRole === 'åŒºåŸŸè°ƒåº¦å‘˜' || userRole === 'è¶…çº§ç®¡ç†å‘˜') {
        dispatchTrack = 'è½¨é“B';
        console.log('è®¾ç½®ä¸ºè½¨é“B - åŒºåŸŸè°ƒåº¦å‘˜/è¶…çº§ç®¡ç†å‘˜');
    } else {
        console.log('æœªåŒ¹é…è§’è‰²ï¼Œä½¿ç”¨é»˜è®¤è½¨é“A');
    }
    console.log('æœ€ç»ˆé€‰æ‹©çš„è½¨é“ç±»å‹:', dispatchTrack);
    
    // å‡†å¤‡APIæ•°æ® - ä½¿ç”¨åç«¯éªŒè¯æœŸæœ›çš„å­—æ®µå
    const apiData = {
        requirement_type: data.requirement_type,
        start_location: data.start_location,
        end_location: data.end_location,
        carrier_company: data.carrier_company,
        transport_type: data.transport_type,
        weight: data.weight,
        volume: parseInt(data.volume),
        required_time: data.required_time,
        special_requirements: data.special_requirements || '',
        dispatch_track: dispatchTrack
    };
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';
    submitBtn.disabled = true;
    
    // ä½¿ç”¨AJAXå·¥å…·åˆ›å»ºä»»åŠ¡
    $ajax.post('/api/dispatch/tasks', apiData)
        .then(result => {
            if (result.success) {
                showToast('æ´¾è½¦ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼', 'success');
                this.reset();
                // é‡ç½®å®¹ç§¯è¾“å…¥çŠ¶æ€
                document.getElementById('volumeInput').disabled = true;
                document.getElementById('volumeHint').textContent = 'è¯·å…ˆé€‰æ‹©é‡é‡ï¼Œå®¹ç§¯å¿…é¡»å¤§äºç­‰äºå¯¹åº”æœ€å°å€¼';
                
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                loadDispatchTasks();
            } else {
                showToast('åˆ›å»ºå¤±è´¥: ' + (result.error?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message && error.message.includes('401')) {
                showToast('è¯·å…ˆç™»å½•ç³»ç»Ÿ', 'error');
                // å¯ä»¥é‡å®šå‘åˆ°ç™»å½•é¡µé¢
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        })
        .finally(() => {
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> åˆ›å»ºæ´¾è½¦ä»»åŠ¡';
            submitBtn.disabled = false;
        });
});

// é¡µé¢åŠ è½½æ—¶ç¦ç”¨å®¹ç§¯è¾“å…¥å¹¶æ£€æŸ¥ç™»å½•çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('volumeInput').disabled = true;
    
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€...');
    
    // æ— è®ºæ˜¯å¦ç™»å½•ï¼Œéƒ½å°è¯•åŠ è½½ä»»åŠ¡ï¼ˆAPIä¼šå¤„ç†æƒé™é—®é¢˜ï¼‰
    loadDispatchTasks();
    
    // æ·»åŠ å®šæ—¶å™¨ï¼Œé˜²æ­¢æ— é™åŠ è½½
    setTimeout(() => {
        const loadingDiv = document.getElementById('loading-tasks');
        if (loadingDiv && loadingDiv.style.display !== 'none') {
            console.log('åŠ è½½è¶…æ—¶ï¼Œéšè—åŠ è½½çŠ¶æ€');
            loadingDiv.style.display = 'none';
            const noTasksDiv = document.getElementById('no-tasks');
            if (noTasksDiv) {
                noTasksDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted">åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                    <button class="feishu-btn feishu-btn-secondary mt-2" onclick="location.reload()">
                        åˆ·æ–°é¡µé¢
                    </button>
                `;
                noTasksDiv.style.display = 'block';
            }
        }
    }, 10000); // 10ç§’è¶…æ—¶
});

// æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥å°è¯•åŠ è½½ä»»åŠ¡ï¼‰
async function checkLoginStatus() {
    try {
        // ç›´æ¥å°è¯•åŠ è½½ä»»åŠ¡ï¼Œå¦‚æœæˆåŠŸåˆ™è¯´æ˜å·²ç™»å½•
        const result = await $ajax.get('/api/dispatch/tasks', { limit: 1, page: 1 });
        return result.success === true;
    } catch (error) {
        return false;
    }
}

// åŠ è½½æ´¾è½¦ä»»åŠ¡åˆ—è¡¨
async function loadDispatchTasks() {
    const loadingDiv = document.getElementById('loading-tasks');
    const noTasksDiv = document.getElementById('no-tasks');
    
    console.log('å¼€å§‹åŠ è½½æ´¾è½¦ä»»åŠ¡...');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    if (loadingDiv) {
        loadingDiv.style.display = 'block';
        console.log('æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
    }
    if (noTasksDiv) noTasksDiv.style.display = 'none';
    
    try {
        console.log('æ­£åœ¨è°ƒç”¨APIè·å–ä»»åŠ¡...');
        const result = await $ajax.get('/api/dispatch/tasks', {
            limit: 100,
            page: 1
        }).catch(error => {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);
            throw error;
        });
        
        console.log('APIè°ƒç”¨å®Œæˆ:', result);
        
        // éšè—åŠ è½½çŠ¶æ€
        if (loadingDiv) loadingDiv.style.display = 'none';
        
        if (result && result.success && result.data) {
            console.log('è·å–åˆ°ä»»åŠ¡æ•°æ®:', result.data.list?.length || 0, 'æ¡');
            if (result.data.list && result.data.list.length > 0) {
                renderDispatchTasks(result.data.list);
            } else {
                console.log('æ²¡æœ‰ä»»åŠ¡æ•°æ®');
                if (noTasksDiv) {
                    noTasksDiv.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">æš‚æ— æ´¾è½¦è®°å½•</p>
                        </div>
                    `;
                    noTasksDiv.style.display = 'block';
                }
            }
        } else {
            console.log('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', result);
            if (noTasksDiv) {
                noTasksDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-muted">æ•°æ®åŠ è½½å¼‚å¸¸</p>
                        <button class="feishu-btn feishu-btn-secondary" onclick="loadDispatchTasks()">
                            <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
                noTasksDiv.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
        
        // éšè—åŠ è½½çŠ¶æ€
        if (loadingDiv) loadingDiv.style.display = 'none';
        
        // æ£€æŸ¥HTTPçŠ¶æ€ç æˆ–é”™è¯¯ä¿¡æ¯
        const errorMessage = error.message || '';
        const statusCode = error.status || error.code || 0;
        console.log('é”™è¯¯è¯¦æƒ…:', errorMessage, 'çŠ¶æ€ç :', statusCode);
        
        // æ›´å‡†ç¡®çš„é”™è¯¯æ£€æµ‹
        const isAuthError = statusCode === 401 || 
                           errorMessage.includes('401') || 
                           errorMessage.includes('æœªç™»å½•') || 
                           errorMessage.includes('æƒé™') ||
                           errorMessage.includes('4002');
        
        const isNetworkError = errorMessage.includes('Network') || 
                              errorMessage.includes('ç½‘ç»œ') ||
                              errorMessage.includes('Failed to fetch');
        
        if (isAuthError) {
            console.log('æ£€æµ‹åˆ°æœªç™»å½•çŠ¶æ€');
            if (noTasksDiv) {
                noTasksDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-3">è¯·å…ˆç™»å½•æŸ¥çœ‹æ´¾è½¦è®°å½•</p>
                        <button class="feishu-btn feishu-btn-primary" onclick="window.location.href='/login'">
                            <i class="fas fa-sign-in-alt"></i> å»ç™»å½•
                        </button>
                    </div>
                `;
                noTasksDiv.style.display = 'block';
            }
        } else if (isNetworkError) {
            console.log('æ£€æµ‹åˆ°ç½‘ç»œé”™è¯¯');
            if (noTasksDiv) {
                noTasksDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-wifi fa-3x text-warning mb-3"></i>
                        <p class="text-muted mb-3">ç½‘ç»œè¿æ¥é”™è¯¯</p>
                        <button class="feishu-btn feishu-btn-secondary" onclick="loadDispatchTasks()">
                            <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
                noTasksDiv.style.display = 'block';
            }
        } else {
            console.log('æ£€æµ‹åˆ°å…¶ä»–é”™è¯¯');
            if (noTasksDiv) {
                noTasksDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-muted mb-3">åŠ è½½å¤±è´¥ï¼š${errorMessage}</p>
                        <button class="feishu-btn feishu-btn-secondary" onclick="loadDispatchTasks()">
                            <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
                noTasksDiv.style.display = 'block';
            }
        }
    }
}

// åˆ†é¡µç›¸å…³å˜é‡
let currentPage = 1;
const itemsPerPage = 9; // 3Ã—3å¸ƒå±€
let allTasks = [];

// æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¢å¤ä¸ºåˆ—è¡¨å¸ƒå±€ï¼‰
function renderDispatchTasks(tasks) {
    console.log('=== renderDispatchTasks å¼€å§‹æ‰§è¡Œ ===');
    console.log('æ¥æ”¶åˆ°çš„ä»»åŠ¡æ•°æ®:', tasks);
    console.log('ä»»åŠ¡æ•°é‡:', tasks ? tasks.length : 0);
    
    const container = document.getElementById('tasks-container');
    const loadingDiv = document.getElementById('loading-tasks');
    const noTasksDiv = document.getElementById('no-tasks');
    
    console.log('å®¹å™¨å…ƒç´ :', container);
    console.log('åŠ è½½å…ƒç´ :', loadingDiv);
    console.log('ç©ºæ•°æ®å…ƒç´ :', noTasksDiv);
    
    if (!container) {
        console.error('âŒ æ‰¾ä¸åˆ° .dispatch-list å®¹å™¨');
        return;
    }
    
    // éšè—åŠ è½½çŠ¶æ€
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
        console.log('âœ… å·²éšè—åŠ è½½çŠ¶æ€');
    }
    
    // æ¸…ç©ºç°æœ‰ä»»åŠ¡é¡¹
    const existingItems = container.querySelectorAll('.dispatch-item');
    console.log('éœ€è¦æ¸…ç†çš„ç°æœ‰ä»»åŠ¡é¡¹æ•°é‡:', existingItems.length);
    existingItems.forEach(item => item.remove());
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡
    if (!tasks || tasks.length === 0) {
        console.log('ğŸ“­ æ²¡æœ‰ä»»åŠ¡æ•°æ®ï¼Œæ˜¾ç¤ºç©ºæç¤º');
        if (noTasksDiv) {
            noTasksDiv.style.display = 'block';
            noTasksDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">æš‚æ— æ´¾è½¦è®°å½•</p>
                    <small class="text-muted">å½“å‰æ²¡æœ‰æ´¾è½¦ä»»åŠ¡æ•°æ®</small>
                </div>
            `;
        }
        return;
    }
    
    console.log(`ğŸ¯ å¼€å§‹æ¸²æŸ“ ${tasks.length} ä¸ªä»»åŠ¡`);
    
    // éšè—ç©ºæ•°æ®æç¤º
    if (noTasksDiv) noTasksDiv.style.display = 'none';
    
    // ç›´æ¥æ¸²æŸ“æ‰€æœ‰ä»»åŠ¡ä¸ºåˆ—è¡¨ï¼ˆä¸åˆ†é¡µï¼‰
    tasks.forEach((task, index) => {
        console.log(`æ­£åœ¨å¤„ç†ç¬¬ ${index + 1} ä¸ªä»»åŠ¡:`, task);
        const taskElement = createTaskElement(task);
        if (taskElement) {
            container.appendChild(taskElement);
            console.log(`âœ… ç¬¬ ${index + 1} ä¸ªä»»åŠ¡å·²æ·»åŠ åˆ°å®¹å™¨`);
        } else {
            console.error(`âŒ ç¬¬ ${index + 1} ä¸ªä»»åŠ¡åˆ›å»ºå¤±è´¥`);
        }
    });
    
    console.log('=== renderDispatchTasks æ‰§è¡Œå®Œæˆ ===');
}

// æ¸²æŸ“åˆ†é¡µæ§ä»¶
function renderPaginationControls() {
    const container = document.querySelector('.dispatch-list');
    const totalPages = Math.ceil(allTasks.length / itemsPerPage);
    
    const paginationContainer = document.createElement('div');
    paginationContainer.className = 'pagination-container feishu-card mt-4 p-3';
    paginationContainer.style.display = 'flex';
    paginationContainer.style.justifyContent = 'center';
    paginationContainer.style.alignItems = 'center';
    paginationContainer.style.gap = '10px';
    
    // ä¸Šä¸€é¡µæŒ‰é’®
    const prevBtn = document.createElement('button');
    prevBtn.className = 'feishu-btn feishu-btn-secondary feishu-btn-sm';
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    
    // é¡µç æ˜¾ç¤º
    const pageInfo = document.createElement('span');
    pageInfo.className = 'page-info';
    pageInfo.style.margin = '0 15px';
    pageInfo.style.fontSize = '14px';
    pageInfo.style.color = 'var(--feishu-text-secondary)';
    pageInfo.innerHTML = `ç¬¬ ${currentPage} / ${totalPages} é¡µ (å…± ${allTasks.length} æ¡è®°å½•)`;
    
    // ä¸‹ä¸€é¡µæŒ‰é’®
    const nextBtn = document.createElement('button');
    nextBtn.className = 'feishu-btn feishu-btn-secondary feishu-btn-sm';
    nextBtn.innerHTML = 'ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    
    paginationContainer.appendChild(prevBtn);
    paginationContainer.appendChild(pageInfo);
    paginationContainer.appendChild(nextBtn);
    
    container.appendChild(paginationContainer);
}

// åˆ‡æ¢é¡µé¢
function changePage(newPage) {
    const totalPages = Math.ceil(allTasks.length / itemsPerPage);
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderPaginatedTasks();
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// åˆ›å»ºä»»åŠ¡å…ƒç´ ï¼ˆæ¢å¤ä¸ºåˆ—è¡¨å¸ƒå±€æ ·å¼ï¼‰
function createTaskElement(task) {
    console.log('ğŸ¯ createTaskElement è¢«è°ƒç”¨');
    console.log('ä»»åŠ¡å¯¹è±¡:', task);
    
    if (!task) {
        console.error('âŒ createTaskElement: ä»»åŠ¡å¯¹è±¡ä¸ºç©º');
        return null;
    }
    
    const div = document.createElement('div');
    div.className = 'dispatch-item feishu-card p-4 mb-3';
    
    console.log('ğŸ“ å¼€å§‹æ„å»ºä»»åŠ¡å¡ç‰‡...');
    
    // çŠ¶æ€æ ·å¼æ˜ å°„ - ä½¿ç”¨é£ä¹¦é£æ ¼çŠ¶æ€æ ‡ç­¾ï¼ˆæ¸…æ™°å‘½åç‰ˆï¼‰
    const statusMap = {
        'å¾…æäº¤': { class: 'feishu-badge-pending', text: 'å¾…æäº¤' },
        'å¾…è°ƒåº¦å‘˜å®¡æ ¸': { class: 'feishu-badge-pending', text: 'å¾…å®¡æ ¸' },
        'å¾…ä¾›åº”å•†å“åº”': { class: 'feishu-badge-pending', text: 'å¾…å“åº”' },
        'ä¾›åº”å•†å·²å“åº”': { class: 'feishu-badge-processing', text: 'å·²å“åº”' },
        'è½¦é—´å·²æ ¸æŸ¥': { class: 'feishu-badge-processing', text: 'å·²æ ¸æŸ¥' },
        'ä¾›åº”å•†å·²ç¡®è®¤': { class: 'feishu-badge-processing', text: 'å·²ç¡®è®¤' },
        'ä»»åŠ¡ç»“æŸ': { class: 'feishu-badge-completed', text: 'å·²ç»“æŸ' },
        'å·²å–æ¶ˆ': { class: 'feishu-badge-error', text: 'å·²å–æ¶ˆ' }
    };
    
    const statusInfo = statusMap[task.status] || { class: 'feishu-badge-pending', text: task.status };
    
    // è·å–å§‹å‘å±€å’Œçº¿è·¯ä¿¡æ¯ç”¨äºæ˜¾ç¤º
    const weight = task.weight || task.cargo_weight || 0;
    const volume = task.volume || task.cargo_volume || 0;
    const transportType = task.transport_type || task.vehicle_type || 'æ™®é€šè¿è¾“';
    const requiredDate = task.required_date || task.expected_start_time || '';
    const specialReq = task.special_requirements || '';
    
    console.log('ğŸ“Š ä»»åŠ¡æ•°æ®è§£æå®Œæˆ:', {
        weight, volume, transportType, requiredDate, specialReq, status: task.status
    });
    
    try {
        div.innerHTML = `
            <div class="feishu-row align-items-start">
                <div class="feishu-col">
                    <!-- è·¯çº¿æ ‡é¢˜ -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="route-icon-wrapper me-3">
                            <i class="fas fa-route" style="color: var(--feishu-primary); font-size: 20px;"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="route-display mb-2" style="font-size: 16px; font-weight: 600; color: var(--feishu-text-primary);">
                                <span style="color: var(--feishu-text-secondary);">å§‹å‘å±€ï¼š</span>
                                <span style="color: var(--feishu-primary);">${task.start_bureau || 'æœªçŸ¥å§‹å‘å±€'}</span>
                            </div>
                            <div class="route-display mb-1" style="font-size: 16px; font-weight: 600; color: var(--feishu-text-primary);">
                                <span style="color: var(--feishu-text-secondary);">çº¿è·¯ï¼š</span>
                                <span style="color: var(--feishu-primary);">${task.route_name || 'æœªçŸ¥çº¿è·¯'}</span>
                            </div>
                            <span class="${statusInfo.class} feishu-badge">
                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                ${statusInfo.text}
                            </span>
                        </div>
                    </div>
                    
                    <!-- ä»»åŠ¡ä¿¡æ¯ç½‘æ ¼ -->
                    <div class="feishu-row mb-3">
                        <div class="feishu-col-md-6">
                            <div class="info-item">
                                <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                    <i class="fas fa-truck me-2" style="color: var(--feishu-text-tertiary);"></i>è¿è¾“ç±»å‹
                                </span>
                                <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px;">
                                    ${transportType}
                                </div>
                            </div>
                        </div>
                        <div class="feishu-col-md-6">
                            <div class="info-item">
                                <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                    <i class="fas fa-clock me-2" style="color: var(--feishu-text-tertiary);"></i>è¦æ±‚æ—¶é—´
                                </span>
                                <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px;">
                                    ${formatDateTime(requiredDate)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feishu-row mb-3">
                        <div class="feishu-col-md-4">
                            <div class="info-item">
                                <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                    <i class="fas fa-weight-hanging me-2" style="color: var(--feishu-text-tertiary);"></i>é‡é‡
                                </span>
                                <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px;">
                                    ${weight} å¨
                                </div>
                            </div>
                        </div>
                        <div class="feishu-col-md-4">
                            <div class="info-item">
                                <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                    <i class="fas fa-box me-2" style="color: var(--feishu-text-tertiary);"></i>å®¹ç§¯
                                </span>
                                <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px;">
                                    ${volume} ç«‹æ–¹ç±³
                                </div>
                            </div>
                        </div>
                        <div class="feishu-col-md-4">
                            <div class="info-item">
                                <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                    <i class="fas fa-hashtag me-2" style="color: var(--feishu-text-tertiary);"></i>ä»»åŠ¡ç¼–å·
                                </span>
                                <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px; font-family: 'Courier New', monospace;">
                                    ${task.task_id || 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç‰¹æ®Šè¦æ±‚å’Œæ‰¿è¿å•†ä¿¡æ¯ -->
                     ${specialReq || task.carrier_company ? `
                     <div class="additional-info" style="border-top: 1px solid var(--feishu-border-light); padding-top: 12px;">
                         ${specialReq ? `
                             <div class="info-item mb-2">
                                 <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                     <i class="fas fa-exclamation-triangle me-2" style="color: var(--feishu-warning);"></i>ç‰¹æ®Šè¦æ±‚
                                 </span>
                                 <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px; line-height: 1.5;">
                                     ${specialReq}
                                 </div>
                             </div>
                         ` : ''}
                     </div>
                     ` : ''}
                     
                     <!-- æ“ä½œæŒ‰é’® -->
                     <div class="action-buttons mt-3 pt-3" style="border-top: 1px solid var(--feishu-border-light);">
                         <button class="feishu-btn feishu-btn-primary feishu-btn-sm" onclick="viewTaskDetails('${task.task_id}')">
                             <i class="fas fa-eye me-1"></i> æŸ¥çœ‹è¯¦æƒ…
                         </button>
                     </div>
                 </div>
             </div>
         `;
         
         console.log('âœ… createTaskElement: ä»»åŠ¡å¡ç‰‡æ„å»ºæˆåŠŸ');
         return div;
    } catch (error) {
        console.error('âŒ createTaskElement: æ„å»ºä»»åŠ¡å¡ç‰‡å¤±è´¥', error);
        return null;
    }
}

// æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
function viewTaskDetails(taskId) {
    console.log('æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…:', taskId);
    // è¿™é‡Œå¯ä»¥æ·»åŠ æŸ¥çœ‹è¯¦æƒ…çš„é€»è¾‘
    showToast('æŸ¥çœ‹ä»»åŠ¡: ' + taskId, 'info');
}

// æ¨æµ‹æ­¤å¤„ä»£ç ä¸ºæŸä¸ªå‡½æ•°ï¼Œè¡¥å……å‡½æ•°å®šä¹‰ä¸ç¼ºå¤±éƒ¨åˆ†
function createTaskCard(task) {
    const div = document.createElement('div');
    div.innerHTML = `
                    ${task.carrier_company ? `
                        <div class="info-item">
                            <span class="info-label" style="font-size: 13px; font-weight: 600; color: var(--feishu-text-secondary);">
                                <i class="fas fa-building me-2" style="color: var(--feishu-primary);"></i>æ‰¿è¿å•†
                            </span>
                            <div class="info-value" style="font-size: 14px; color: var(--feishu-text-primary); margin-top: 4px;">
                                ${task.carrier_company}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    return div;
}
// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    
    try {
        const date = new Date(dateTimeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateTimeStr;
    }
}
</script>
{% endblock %}
